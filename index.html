<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Website Integrator - No Setup Required!</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-card {
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .feature-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .feature-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .feature-card.selected .feature-icon {
            color: white;
        }

        .feature-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #667eea;
        }

        .feature-card h3 {
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .feature-card p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .checkbox-wrapper {
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            display: none;
        }

        .result-card h3 {
            color: #28a745;
            margin-bottom: 15px;
        }

        .demo-link {
            background: white;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .demo-link a {
            color: #28a745;
            text-decoration: none;
            font-weight: 600;
        }

        .demo-link button {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .info-box h3 {
            color: #0066cc;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        .api-key-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .api-key-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .api-key-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .api-key-input input {
            flex: 1;
        }

        .api-key-input button {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-card {
                padding: 20px;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }

            .api-key-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> AI Website Integrator</h1>
            <p>Add AI features to any website with just a few clicks - No setup required!</p>
        </div>

        <div class="api-key-section">
            <h3><i class="fas fa-key"></i> OpenAI API Key Setup</h3>
            <p>Enter your OpenAI API key to enable AI features. Get one for free at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></p>
            <div class="api-key-input">
                <input type="password" id="apiKeyInput" placeholder="sk-your-openai-api-key-here">
                <button onclick="saveApiKey()">Save API Key</button>
            </div>
            <p style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                <i class="fas fa-info-circle"></i> Your API key is stored locally in your browser and never sent to our servers.
            </p>
        </div>

        <div class="info-box">
            <h3><i class="fas fa-info-circle"></i> How it works:</h3>
            <ul>
                <li>Enter your OpenAI API key above</li>
                <li>Paste your website URL in the field below</li>
                <li>Select the AI features you want to integrate</li>
                <li>Describe your business for context-aware AI responses</li>
                <li>Get a live demo link to share with others</li>
            </ul>
        </div>

        <div class="main-card">
            <form id="demoForm">
                <div class="form-group">
                    <label for="websiteUrl">
                        <i class="fas fa-globe"></i> Website URL
                    </label>
                    <input 
                        type="url" 
                        id="websiteUrl" 
                        placeholder="https://example.com" 
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="businessDescription">
                        <i class="fas fa-building"></i> Business Description
                    </label>
                    <textarea 
                        id="businessDescription" 
                        rows="4" 
                        placeholder="Describe what your business does, your products/services, and how you help customers. This helps the AI provide better, context-aware responses."
                    ></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <i class="fas fa-magic"></i> Select AI Features
                    </label>
                    <div class="features-grid" id="featuresGrid">
                        <!-- Features will be loaded here -->
                    </div>
                </div>

                <button type="submit" class="btn" id="createDemoBtn">
                    <i class="fas fa-rocket"></i> Create Live Demo
                </button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Creating your AI-enhanced demo...</p>
            </div>

            <div class="error" id="error"></div>

            <div class="result-card" id="resultCard">
                <h3><i class="fas fa-check-circle"></i> Demo Created Successfully!</h3>
                <p>Your AI-enhanced website demo is ready. Share the link below with others to let them experience your website with AI features.</p>
                
                <div class="demo-link" id="demoLink">
                    <a href="#" id="demoUrl" target="_blank">Loading demo URL...</a>
                    <button onclick="copyToClipboard()">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>

                <div style="margin-top: 20px;">
                    <h4>What's included in your demo:</h4>
                    <ul id="featuresList">
                        <!-- Features will be listed here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFeatures = [];
        let features = {};
        let apiKey = localStorage.getItem('openai_api_key');

        // AI Features Configuration
        const aiFeatures = {
            chat: {
                name: 'AI Help Chat',
                description: 'Intelligent customer support chatbot with context-aware responses',
                icon: 'ðŸ’¬'
            },
            contentGenerator: {
                name: 'Content Generator',
                description: 'AI-powered content creation tools for blogs and marketing',
                icon: 'âœï¸'
            },
            imageGenerator: {
                name: 'Image Generator',
                description: 'Create custom images with AI that match your brand',
                icon: 'ðŸŽ¨'
            },
            formAssistant: {
                name: 'Form Assistant',
                description: 'Smart form filling and validation with AI assistance',
                icon: 'ðŸ“'
            }
        };

        // Save API key
        function saveApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const key = apiKeyInput.value.trim();
            
            if (key && key.startsWith('sk-')) {
                apiKey = key;
                localStorage.setItem('openai_api_key', key);
                apiKeyInput.style.borderColor = '#28a745';
                showMessage('API key saved successfully!', 'success');
            } else {
                apiKeyInput.style.borderColor = '#dc3545';
                showMessage('Please enter a valid OpenAI API key (starts with sk-)', 'error');
            }
        }

        // Show message
        function showMessage(message, type) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            errorDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            errorDiv.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

        // Load API key on page load
        if (apiKey) {
            document.getElementById('apiKeyInput').value = apiKey;
        }

        // Render features grid
        function renderFeatures() {
            const grid = document.getElementById('featuresGrid');
            grid.innerHTML = '';

            Object.entries(aiFeatures).forEach(([key, feature]) => {
                const card = document.createElement('div');
                card.className = 'feature-card';
                card.onclick = () => toggleFeature(key, card);

                card.innerHTML = `
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="feature-${key}">
                    </div>
                    <div class="feature-icon">${feature.icon}</div>
                    <h3>${feature.name}</h3>
                    <p>${feature.description}</p>
                `;

                grid.appendChild(card);
            });
        }

        // Toggle feature selection
        function toggleFeature(key, card) {
            const checkbox = document.getElementById(`feature-${key}`);
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                selectedFeatures.push(key);
                card.classList.add('selected');
            } else {
                selectedFeatures = selectedFeatures.filter(f => f !== key);
                card.classList.remove('selected');
            }
        }

        // Handle form submission
        document.getElementById('demoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!apiKey) {
                showMessage('Please enter your OpenAI API key first', 'error');
                return;
            }

            const websiteUrl = document.getElementById('websiteUrl').value;
            const businessDescription = document.getElementById('businessDescription').value;

            if (!websiteUrl) {
                showMessage('Please enter a website URL', 'error');
                return;
            }

            if (selectedFeatures.length === 0) {
                showMessage('Please select at least one AI feature', 'error');
                return;
            }

            // Show loading
            showLoading(true);
            hideError();
            hideResult();

            try {
                // Create demo with global storage
                const demoId = generateDemoId();
                const demoUrl = `${window.location.origin}${window.location.pathname}?demo=${demoId}`;
                
                // Store demo data in cloud storage
                const demoData = {
                    id: demoId,
                    originalUrl: websiteUrl,
                    features: selectedFeatures,
                    businessDescription: businessDescription,
                    createdAt: new Date().toISOString(),
                    demoUrl: demoUrl
                };
                
                const success = await storeDemoGlobally(demoId, demoData);
                
                if (success) {
                    // Show result
                    showResult({
                        success: true,
                        demoId: demoId,
                        demoUrl: demoUrl,
                        message: 'Demo created successfully!'
                    });
                } else {
                    showMessage('Failed to create global demo. Please try again.', 'error');
                }

            } catch (error) {
                showMessage('Failed to create demo. Please try again.', 'error');
            } finally {
                showLoading(false);
            }
        });

        // Generate demo ID
        function generateDemoId() {
            return 'demo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Show/hide loading
        function showLoading(show) {
            const loading = document.getElementById('loading');
            const btn = document.getElementById('createDemoBtn');
            
            loading.style.display = show ? 'block' : 'none';
            btn.disabled = show;
        }

        // Hide error
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        // Show result
        function showResult(data) {
            const resultCard = document.getElementById('resultCard');
            const demoUrl = document.getElementById('demoUrl');
            const featuresList = document.getElementById('featuresList');

            demoUrl.href = data.demoUrl;
            demoUrl.textContent = data.demoUrl;

            // List selected features
            featuresList.innerHTML = selectedFeatures.map(key => 
                `<li><strong>${aiFeatures[key].name}:</strong> ${aiFeatures[key].description}</li>`
            ).join('');

            resultCard.style.display = 'block';
            resultCard.scrollIntoView({ behavior: 'smooth' });
        }

        // Hide result
        function hideResult() {
            document.getElementById('resultCard').style.display = 'none';
        }

        // Copy to clipboard
        function copyToClipboard() {
            const demoUrl = document.getElementById('demoUrl').href;
            navigator.clipboard.writeText(demoUrl).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            });
        }

        // Check if this is a demo page
        function checkForDemo() {
            const urlParams = new URLSearchParams(window.location.search);
            const demoId = urlParams.get('demo');
            
            if (demoId) {
                // This is a demo page - load demo data and show interface
                loadDemoAndShowInterface(demoId);
            }
        }

        // Load demo data and show interface
        async function loadDemoAndShowInterface(demoId) {
            console.log('Loading demo:', demoId);
            
            // Try to load from cloud storage first
            let demoData = await loadDemoFromCloud(demoId);
            
            if (!demoData) {
                // Fallback to localStorage for backward compatibility
                const localData = localStorage.getItem(`demo_${demoId}`);
                if (localData) {
                    try {
                        demoData = JSON.parse(localData);
                    } catch (e) {
                        console.error('Failed to parse local demo data:', e);
                    }
                }
            }
            
            if (demoData) {
                console.log('Demo data found:', demoData);
                // demoData is already parsed, don't parse again
                document.body.innerHTML = createDemoHTML(demoData);
                setupDemoInteractions(demoData);
            } else {
                console.log('No demo data found for:', demoId);
                document.body.innerHTML = '<div style="text-align: center; padding: 50px;"><h2>Demo not found</h2><p>The demo you\'re looking for doesn\'t exist or has expired.</p><p><a href="index.html">Create a new demo</a></p></div>';
            }
        }

        // Create demo HTML
        function createDemoHTML(demo) {
            return `
                <style>
                    body { margin: 0; overflow: hidden; }
                    #ai-demo-root { position: fixed; inset: 0; }
                    #siteFrame { position: fixed; inset: 0; width: 100vw; height: 100vh; border: none; z-index: 0; background: #fff; }
                    .ai-overlay { position: fixed; inset: 0; z-index: 2147483647; pointer-events: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
                    .ai-demo-topbar { position: fixed; left: 50%; top: 12px; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: #fff; padding: 8px 14px; border-radius: 9999px; font-size: 14px; display: flex; align-items: center; gap: 10px; pointer-events: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2); backdrop-filter: blur(6px); }
                    .ai-demo-topbar a { color: #fff; text-decoration: underline; }
                    .ai-feature-chips { display: flex; align-items: center; gap: 6px; }
                    .ai-chip { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); color: #fff; padding: 4px 10px; border-radius: 9999px; font-size: 12px; }
                    .ai-chat-toggle { position: fixed; right: 20px; bottom: 20px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.25); cursor: pointer; pointer-events: auto; display: flex; align-items: center; justify-content: center; font-size: 22px; }
                    .ai-chat-widget { position: fixed; right: 20px; bottom: 90px; width: 360px; max-width: calc(100vw - 40px); max-height: 70vh; background: #fff; border-radius: 14px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); display: none; flex-direction: column; overflow: hidden; pointer-events: auto; border: 1px solid #e8e8ef; }
                    .ai-chat-widget.open { display: flex; }
                    .ai-chat-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; }
                    .ai-chat-header h4 { font-size: 16px; font-weight: 700; }
                    .ai-chat-messages { padding: 14px; display: flex; flex-direction: column; gap: 10px; overflow: auto; background: #f7f8fb; flex: 1; }
                    .ai-msg { display: grid; grid-template-columns: 28px 1fr; gap: 10px; align-items: start; }
                    .ai-avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
                    .ai-avatar.user { background: #e9efff; color: #3b5bdb; }
                    .ai-avatar.bot { background: #eaf7ef; color: #2b8a3e; }
                    .ai-bubble { background: #fff; border: 1px solid #e8e8ef; border-radius: 12px; padding: 10px 12px; color: #333; }
                    .ai-chat-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #eee; background: #fff; }
                    .ai-chat-input input { flex: 1; padding: 12px; border: 1px solid #e1e5e9; border-radius: 10px; font-size: 14px; }
                    .ai-chat-input button { padding: 10px 14px; border-radius: 10px; border: none; background: #667eea; color: #fff; font-weight: 600; cursor: pointer; }
                    .ai-toast { position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 13px; display: none; pointer-events: auto; }
                    .iframe-fallback { position: fixed; inset: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 40px; z-index: 1; }
                    .iframe-fallback h2 { font-size: 2rem; margin-bottom: 20px; }
                    .iframe-fallback p { font-size: 1.1rem; margin-bottom: 30px; max-width: 600px; line-height: 1.6; }
                    .iframe-fallback .btn { background: white; color: #667eea; padding: 15px 30px; border-radius: 10px; text-decoration: none; font-weight: 600; margin: 10px; display: inline-block; }
                    @media (max-width: 480px) { .ai-chat-widget { right: 10px; left: 10px; width: auto; } }
                </style>
                <div id="ai-demo-root">
                    <iframe id="siteFrame" src="${demo.originalUrl}" onload="checkIframeLoad()" onerror="showIframeFallback()"></iframe>
                    <div id="iframeFallback" class="iframe-fallback" style="display: none;">
                        <h2><i class="fas fa-exclamation-triangle"></i> Website Preview Unavailable</h2>
                        <p>This website cannot be embedded due to security settings. However, you can still interact with the AI assistant to learn about the business and get information.</p>
                        <a href="${demo.originalUrl}" target="_blank" class="btn">
                            <i class="fas fa-external-link-alt"></i> Visit Original Website
                        </a>
                        <button onclick="hideIframeFallback()" class="btn" style="background: rgba(255,255,255,0.2); color: white;">
                            <i class="fas fa-eye"></i> Continue with AI Demo
                        </button>
                    </div>
                    <div class="ai-overlay">
                        <div class="ai-demo-topbar">
                            <span><i class="fas fa-robot"></i> AI Demo Mode</span>
                            <span style="opacity: 0.9;">|</span>
                            <span style="opacity: 0.9;">${demo.originalUrl}</span>
                            <div class="ai-feature-chips">
                                ${demo.features.map(f => `<span class="ai-chip">${aiFeatures[f].icon} ${aiFeatures[f].name}</span>`).join('')}
                            </div>
                            <a href="index.html" style="margin-left: 8px;">Create your own</a>
                        </div>
                        <button id="ai-chat-toggle" class="ai-chat-toggle" title="Chat">
                            <i class="fas fa-comments"></i>
                        </button>
                        <div id="ai-chat-widget" class="ai-chat-widget">
                            <div class="ai-chat-header">
                                <h4>AI Assistant</h4>
                                <button id="ai-chat-close" style="background: transparent; border: none; color: #fff; font-size: 18px; cursor: pointer;">Ã—</button>
                            </div>
                            <div id="ai-chat-messages" class="ai-chat-messages"></div>
                            <form id="ai-chat-form" class="ai-chat-input">
                                <input id="ai-chat-input" type="text" placeholder="Ask about products, services, pricing..." autocomplete="off" />
                                <button type="submit"><i class="fas fa-paper-plane"></i></button>
                            </form>
                        </div>
                        <div id="ai-toast" class="ai-toast"></div>
                    </div>
                </div>
                <script>
                    function checkIframeLoad() {
                        setTimeout(() => {
                            try {
                                const frame = document.getElementById('siteFrame');
                                if (frame.contentWindow.location.href === 'about:blank' || 
                                    frame.contentWindow.location.href.includes('blocked') ||
                                    frame.contentDocument.body.innerHTML.length < 100) {
                                    showIframeFallback();
                                }
                            } catch (e) {
                                showIframeFallback();
                            }
                        }, 3000);
                    }
                    
                    function showIframeFallback() {
                        document.getElementById('iframeFallback').style.display = 'flex';
                    }
                    
                    function hideIframeFallback() {
                        document.getElementById('iframeFallback').style.display = 'none';
                    }
                </script>
            `;
        }
        }

        // Attach overlay interactions and optional AI responses
        async function setupDemoInteractions(demo) {
            const toggleBtn = document.getElementById('ai-chat-toggle');
            const closeBtn = document.getElementById('ai-chat-close');
            const widget = document.getElementById('ai-chat-widget');
            const form = document.getElementById('ai-chat-form');
            const input = document.getElementById('ai-chat-input');
            const messages = document.getElementById('ai-chat-messages');
            const toast = document.getElementById('ai-toast');
            const frame = document.getElementById('siteFrame');
            let siteContext = null;

            function showToast(text) {
                toast.textContent = text;
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; }, 3000);
            }

            toggleBtn.addEventListener('click', () => {
                widget.classList.toggle('open');
                if (widget.classList.contains('open')) {
                    input.focus();
                }
            });
            closeBtn.addEventListener('click', () => widget.classList.remove('open'));

            // Build site context best-effort
            try {
                siteContext = await buildSiteContext(frame, demo);
                if (siteContext && siteContext.summary) {
                    showToast('Site context loaded for smarter answers');
                }
            } catch (_) {
                // Ignore; limited mode
            }

            // Welcome message
            appendMessage('bot', `Hi! I am your AI assistant for <strong>${escapeHtml(demo.originalUrl)}</strong>. Ask me anything about this business.\n\nFeatures enabled: ${demo.features.map(f => aiFeatures[f].name).join(', ')}.${siteContext && siteContext.summary ? '\n\nI have analyzed the page content for more accurate answers.' : ''}`);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const question = input.value.trim();
                if (!question) return;
                appendMessage('user', escapeHtml(question));
                input.value = '';
                const thinkingId = appendMessage('bot', '<em>Thinking...</em>');
                try {
                    const answer = await generateAIResponse(question, demo, siteContext);
                    replaceMessage(thinkingId, 'bot', answer);
                } catch (err) {
                    replaceMessage(thinkingId, 'bot', 'Sorry, I could not generate a response right now.');
                }
            });

            // Try to detect embedding issues
            setTimeout(() => {
                // Best-effort notice if frame appears blank for too long
                try {
                    const isBlank = !frame || !frame.contentWindow || frame.contentWindow.location.href === 'about:blank';
                    if (isBlank) {
                        showToast('Note: Some sites block embedding. If the background is blank, try another URL.');
                    }
                } catch (_) {
                    // Cross-origin access blocked; ignore
                }
            }, 5000);
        }

        function appendMessage(role, htmlContent) {
            const messages = document.getElementById('ai-chat-messages');
            const id = 'm_' + Math.random().toString(36).slice(2);
            const wrapper = document.createElement('div');
            wrapper.className = 'ai-msg';
            wrapper.id = id;
            const avatar = document.createElement('div');
            avatar.className = 'ai-avatar ' + (role === 'user' ? 'user' : 'bot');
            avatar.textContent = role === 'user' ? 'ðŸ˜Š' : 'ðŸ¤–';
            const bubble = document.createElement('div');
            bubble.className = 'ai-bubble';
            bubble.innerHTML = htmlContent;
            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
            messages.appendChild(wrapper);
            messages.scrollTop = messages.scrollHeight;
            return id;
        }

        function replaceMessage(id, role, htmlContent) {
            const node = document.getElementById(id);
            if (!node) return;
            const bubble = node.querySelector('.ai-bubble');
            if (bubble) bubble.innerHTML = htmlContent;
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, (m) => map[m]);
        }

        async function generateAIResponse(question, demo, siteContext) {
            const key = apiKey || localStorage.getItem('openai_api_key');
            const featureList = demo.features.map(f => aiFeatures[f].name).join(', ');
            const contextSnippet = siteContext && siteContext.summary ? `\n\nPage summary:\n${truncate(siteContext.summary, 3500)}` : '';
            const extractedHints = siteContext && siteContext.highlights && siteContext.highlights.length ? `\n\nKey details:\n- ${siteContext.highlights.join('\n- ')}` : '';
            const system = `You are an AI assistant overlaid on the user's website. Website URL: ${demo.originalUrl}. Use the business description and extracted on-page content when available. When asked for specific details (address, pricing, contact), look for them in the provided page summary and key details. If not present, say so briefly and suggest where to find them on the site. Keep answers concise and accurate. Enabled features: ${featureList}.`;
            const userPrompt = `Business description: ${demo.businessDescription || '(not provided)'}${contextSnippet}${extractedHints}\n\nUser question: ${question}`;

            if (!key) {
                const retrieval = retrieveFromContext(question, siteContext);
                if (retrieval) {
                    return retrieval;
                }
                return `I do not have an API key, so here is a best-effort response based on available info.\n\n${escapeHtml(demo.businessDescription || 'No description provided yet.')}\n\nFor your question: "${escapeHtml(question)}", I can help explain offerings, guide to relevant sections, or collect contact info. To enable richer answers, add your API key at the top of the main page.`;
            }

            try {
                const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + key,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: system },
                            { role: 'user', content: userPrompt }
                        ],
                        temperature: 0.6,
                        max_tokens: 300
                    })
                });
                if (!resp.ok) {
                    throw new Error('API error ' + resp.status);
                }
                const data = await resp.json();
                const answer = data.choices?.[0]?.message?.content?.trim() || 'Sorry, I could not generate a response.';
                return escapeHtml(answer).replace(/\n/g, '<br>');
            } catch (e) {
                return 'There was a problem contacting the AI service. Please check your API key and internet connection.';
            }
        }

        // Build site context from iframe or fetching HTML (best-effort; cross-origin may limit)
        async function buildSiteContext(frame, demo) {
            const cacheKey = `site_ctx_${demo.id}`;
            try {
                const cached = sessionStorage.getItem(cacheKey);
                if (cached) return JSON.parse(cached);
            } catch (_) {}

            // Try iframe DOM extraction (works only if same-origin or permissive)
            let ctx = null;
            try {
                await waitForFrame(frame, 8000);
                ctx = extractFromDocument(frame.contentDocument || frame.contentWindow?.document, demo.originalUrl);
            } catch (_) {
                // Ignore
            }

            // Fallback: try fetching HTML if CORS allows
            if (!ctx || !ctx.summary) {
                try {
                    const html = await fetchHtmlBestEffort(demo.originalUrl);
                    if (html) {
                        const doc = new DOMParser().parseFromString(html, 'text/html');
                        ctx = extractFromDocument(doc, demo.originalUrl);
                    }
                } catch (_) {}
            }

            if (ctx && ctx.summary) {
                try { sessionStorage.setItem(cacheKey, JSON.stringify(ctx)); } catch (_) {}
                return ctx;
            }
            return null;
        }

        function extractFromDocument(doc, baseUrl) {
            if (!doc) return null;
            const getText = (el) => (el ? (el.innerText || el.textContent || '').trim() : '');
            const title = (doc.querySelector('title')?.textContent || '').trim();
            const metaDescription = (doc.querySelector('meta[name="description"]')?.getAttribute('content') || '').trim();
            const headings = Array.from(doc.querySelectorAll('h1, h2, h3')).map(h => h.textContent.trim()).filter(Boolean).slice(0, 20);
            const navLinks = Array.from(doc.querySelectorAll('nav a, header a')).map(a => ({ text: (a.textContent || '').trim(), href: a.getAttribute('href') || '' })).filter(l => l.text).slice(0, 25);
            const addressTags = Array.from(doc.querySelectorAll('address')).map(a => a.textContent.trim()).filter(Boolean);
            const allText = getText(doc.body).replace(/\s+/g, ' ').trim();
            const pricingSnippets = findSnippets(allText, /(price|pricing|cost|plan|package)/i, 6);
            const contactSnippets = findSnippets(allText, /(contact|call|email|phone|address|location)/i, 6);
            const phones = Array.from(allText.match(/\+?\d[\d\s().-]{6,}\d/g) || []).slice(0, 5);
            const emails = Array.from(allText.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/ig) || []).slice(0, 5);
            const addresses = addressTags.concat(findAddressCandidates(allText)).slice(0, 5);
            const highlights = [];
            if (phones.length) highlights.push(`Phone: ${phones.join(', ')}`);
            if (emails.length) highlights.push(`Email: ${emails.join(', ')}`);
            if (addresses.length) highlights.push(`Address: ${addresses[0]}`);
            if (pricingSnippets.length) highlights.push('Pricing info detected');

            const navResolved = navLinks.map(l => ({ text: l.text, href: resolveUrl(baseUrl, l.href) }));
            const summaryParts = [];
            if (title) summaryParts.push(`Title: ${title}`);
            if (metaDescription) summaryParts.push(`Description: ${metaDescription}`);
            if (headings.length) summaryParts.push(`Headings: ${headings.join(' | ')}`);
            if (navResolved.length) summaryParts.push(`Navigation: ${navResolved.slice(0, 10).map(n => n.text).join(' | ')}`);
            if (pricingSnippets.length) summaryParts.push(`Pricing snippets: ${pricingSnippets.join(' ... ')}`);
            if (contactSnippets.length) summaryParts.push(`Contact snippets: ${contactSnippets.join(' ... ')}`);

            return {
                title,
                metaDescription,
                headings,
                nav: navResolved,
                phones,
                emails,
                addresses,
                pricingSnippets,
                contactSnippets,
                textSample: truncate(allText, 6000),
                highlights,
                summary: truncate(summaryParts.join('\n'), 7000)
            };
        }

        function findSnippets(text, keywordRegex, windowSize) {
            const sentences = text.split(/(?<=[.!?])\s+/);
            const matches = [];
            for (let i = 0; i < sentences.length; i++) {
                if (keywordRegex.test(sentences[i])) {
                    const start = Math.max(0, i - Math.floor(windowSize / 2));
                    const end = Math.min(sentences.length, i + Math.ceil(windowSize / 2));
                    matches.push(sentences.slice(start, end).join(' '));
                    if (matches.length >= 6) break;
                }
            }
            return matches;
        }

        function findAddressCandidates(text) {
            const lines = text.split(/\n|\.|;/).map(l => l.trim()).filter(Boolean);
            const addr = [];
            for (const line of lines) {
                if (/\d{1,5}\s+\w+/.test(line) && /(street|st\.|ave|avenue|road|rd\.|blvd|suite|ste\.|unit)/i.test(line)) {
                    addr.push(line);
                    if (addr.length >= 3) break;
                }
            }
            return addr;
        }

        function resolveUrl(base, href) {
            try { return new URL(href, base).toString(); } catch (_) { return href || ''; }
        }

        async function waitForFrame(frame, timeoutMs) {
            return new Promise((resolve, reject) => {
                const done = () => resolve();
                const timer = setTimeout(() => reject(new Error('frame load timeout')), timeoutMs || 8000);
                try {
                    if (frame.complete) {
                        clearTimeout(timer);
                        resolve();
                    } else {
                        frame.addEventListener('load', () => { clearTimeout(timer); done(); }, { once: true });
                    }
                } catch (_) {
                    clearTimeout(timer);
                    resolve();
                }
            });
        }

        async function fetchHtmlBestEffort(url) {
            try {
                const resp = await fetch(url, { method: 'GET', mode: 'cors' });
                if (!resp.ok) return null;
                const ct = resp.headers.get('content-type') || '';
                if (!ct.includes('text/html')) return null;
                return await resp.text();
            } catch (_) {
                // As a last resort, try no-cors (opaque) but we cannot read body; return null
                return null;
            }
        }

        function truncate(str, max) {
            if (!str) return '';
            return str.length > max ? str.slice(0, max) + 'â€¦' : str;
        }

        function retrieveFromContext(question, siteContext) {
            if (!siteContext) return null;
            const q = question.toLowerCase();
            const parts = [];
            const push = (label, value) => { if (value) parts.push(`<strong>${label}:</strong> ${escapeHtml(value)}`); };

            if (/address|location/.test(q)) {
                push('Address', siteContext.addresses && siteContext.addresses[0]);
                if (!parts.length) push('Contact snippet', siteContext.contactSnippets && siteContext.contactSnippets[0]);
            }
            if (/price|pricing|cost|fees?/.test(q)) {
                push('Pricing', siteContext.pricingSnippets && siteContext.pricingSnippets[0]);
            }
            if (/phone|call/.test(q)) {
                push('Phone', siteContext.phones && siteContext.phones[0]);
            }
            if (/email|contact/.test(q)) {
                push('Email', siteContext.emails && siteContext.emails[0]);
            }

            // Suggest relevant navigation tabs
            if (siteContext.nav && siteContext.nav.length) {
                const matchingTabs = siteContext.nav.filter(n => {
                    const t = (n.text || '').toLowerCase();
                    return (
                        (/price|pricing|plans|packages/.test(q) && /price|pricing|plan|package/.test(t)) ||
                        (/contact|support|help|location|address|phone|email/.test(q) && /contact|support|help|location/.test(t)) ||
                        (/about|company|team/.test(q) && /about|company|team/.test(t)) ||
                        (/home|services|products|shop|booking|book|reservations?/.test(q) && /home|service|product|shop|book|reservation/.test(t))
                    );
                }).slice(0, 3);
                if (matchingTabs.length) {
                    const links = matchingTabs.map(n => `<a href="${escapeHtml(n.href)}" target="_blank">${escapeHtml(n.text)}</a>`).join(' | ');
                    parts.push(`<strong>Try these sections:</strong> ${links}`);
                }
            }

            if (parts.length) {
                return parts.join('<br>') + '<br><br><em>Note: Extracted from visible page text; please verify on the site.</em>';
            }

            // General fallback: return first relevant snippet
            const any = (siteContext.contactSnippets && siteContext.contactSnippets[0]) || (siteContext.pricingSnippets && siteContext.pricingSnippets[0]);
            return any ? `${escapeHtml(any)}<br><br><em>Source: page text</em>` : null;
        }

        // Store demo data globally using JSONBin.io (free cloud storage)
        async function storeDemoGlobally(demoId, demoData) {
            try {
                // Use JSONBin.io as a free cloud storage solution
                const response = await fetch('https://api.jsonbin.io/v3/b', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Bin-Name': `ai-demo-${demoId}`,
                        'X-Bin-Private': 'false'
                    },
                    body: JSON.stringify(demoData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // Store the bin ID for later retrieval
                    localStorage.setItem(`demo_bin_${demoId}`, result.metadata.id);
                    return true;
                }
            } catch (error) {
                console.error('Failed to store demo globally:', error);
            }
            
            // Fallback: store locally if cloud storage fails
            try {
                localStorage.setItem(`demo_${demoId}`, JSON.stringify(demoData));
                return true;
            } catch (error) {
                console.error('Failed to store demo locally:', error);
                return false;
            }
        }

        // Load demo data from cloud storage
        async function loadDemoFromCloud(demoId) {
            try {
                const binId = localStorage.getItem(`demo_bin_${demoId}`);
                if (binId) {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`);
                    if (response.ok) {
                        const result = await response.json();
                        return result.record; // Return the parsed object, not a string
                    }
                }
            } catch (error) {
                console.error('Failed to load demo from cloud:', error);
            }
            return null;
        }

        // Create demo HTML
        function createDemoHTML(demo) {
            return `
                <style>
                    body { margin: 0; overflow: hidden; }
                    #ai-demo-root { position: fixed; inset: 0; }
                    #siteFrame { position: fixed; inset: 0; width: 100vw; height: 100vh; border: none; z-index: 0; background: #fff; }
                    .ai-overlay { position: fixed; inset: 0; z-index: 2147483647; pointer-events: none; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
                    .ai-demo-topbar { position: fixed; left: 50%; top: 12px; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: #fff; padding: 8px 14px; border-radius: 9999px; font-size: 14px; display: flex; align-items: center; gap: 10px; pointer-events: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.2); backdrop-filter: blur(6px); }
                    .ai-demo-topbar a { color: #fff; text-decoration: underline; }
                    .ai-feature-chips { display: flex; align-items: center; gap: 6px; }
                    .ai-chip { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); color: #fff; padding: 4px 10px; border-radius: 9999px; font-size: 12px; }
                    .ai-chat-toggle { position: fixed; right: 20px; bottom: 20px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.25); cursor: pointer; pointer-events: auto; display: flex; align-items: center; justify-content: center; font-size: 22px; }
                    .ai-chat-widget { position: fixed; right: 20px; bottom: 90px; width: 360px; max-width: calc(100vw - 40px); max-height: 70vh; background: #fff; border-radius: 14px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); display: none; flex-direction: column; overflow: hidden; pointer-events: auto; border: 1px solid #e8e8ef; }
                    .ai-chat-widget.open { display: flex; }
                    .ai-chat-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 12px 14px; display: flex; align-items: center; justify-content: space-between; }
                    .ai-chat-header h4 { font-size: 16px; font-weight: 700; }
                    .ai-chat-messages { padding: 14px; display: flex; flex-direction: column; gap: 10px; overflow: auto; background: #f7f8fb; flex: 1; }
                    .ai-msg { display: grid; grid-template-columns: 28px 1fr; gap: 10px; align-items: start; }
                    .ai-avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
                    .ai-avatar.user { background: #e9efff; color: #3b5bdb; }
                    .ai-avatar.bot { background: #eaf7ef; color: #2b8a3e; }
                    .ai-bubble { background: #fff; border: 1px solid #e8e8ef; border-radius: 12px; padding: 10px 12px; color: #333; }
                    .ai-chat-input { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #eee; background: #fff; }
                    .ai-chat-input input { flex: 1; padding: 12px; border: 1px solid #e1e5e9; border-radius: 10px; font-size: 14px; }
                    .ai-chat-input button { padding: 10px 14px; border-radius: 10px; border: none; background: #667eea; color: #fff; font-weight: 600; cursor: pointer; }
                    .ai-toast { position: fixed; left: 50%; bottom: 20px; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 14px; border-radius: 8px; font-size: 13px; display: none; pointer-events: auto; }
                    .iframe-fallback { position: fixed; inset: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 40px; z-index: 1; }
                    .iframe-fallback h2 { font-size: 2rem; margin-bottom: 20px; }
                    .iframe-fallback p { font-size: 1.1rem; margin-bottom: 30px; max-width: 600px; line-height: 1.6; }
                    .iframe-fallback .btn { background: white; color: #667eea; padding: 15px 30px; border-radius: 10px; text-decoration: none; font-weight: 600; margin: 10px; display: inline-block; }
                    @media (max-width: 480px) { .ai-chat-widget { right: 10px; left: 10px; width: auto; } }
                </style>
                <div id="ai-demo-root">
                    <iframe id="siteFrame" src="${demo.originalUrl}" onload="checkIframeLoad()" onerror="showIframeFallback()"></iframe>
                    <div id="iframeFallback" class="iframe-fallback" style="display: none;">
                        <h2><i class="fas fa-exclamation-triangle"></i> Website Preview Unavailable</h2>
                        <p>This website cannot be embedded due to security settings. However, you can still interact with the AI assistant to learn about the business and get information.</p>
                        <a href="${demo.originalUrl}" target="_blank" class="btn">
                            <i class="fas fa-external-link-alt"></i> Visit Original Website
                        </a>
                        <button onclick="hideIframeFallback()" class="btn" style="background: rgba(255,255,255,0.2); color: white;">
                            <i class="fas fa-eye"></i> Continue with AI Demo
                        </button>
                    </div>
                    <div class="ai-overlay">
                        <div class="ai-demo-topbar">
                            <span><i class="fas fa-robot"></i> AI Demo Mode</span>
                            <span style="opacity: 0.9;">|</span>
                            <span style="opacity: 0.9;">${demo.originalUrl}</span>
                            <div class="ai-feature-chips">
                                ${demo.features.map(f => `<span class="ai-chip">${aiFeatures[f].icon} ${aiFeatures[f].name}</span>`).join('')}
                            </div>
                            <a href="index.html" style="margin-left: 8px;">Create your own</a>
                        </div>
                        <button id="ai-chat-toggle" class="ai-chat-toggle" title="Chat">
                            <i class="fas fa-comments"></i>
                        </button>
                        <div id="ai-chat-widget" class="ai-chat-widget">
                            <div class="ai-chat-header">
                                <h4>AI Assistant</h4>
                                <button id="ai-chat-close" style="background: transparent; border: none; color: #fff; font-size: 18px; cursor: pointer;">Ã—</button>
                            </div>
                            <div id="ai-chat-messages" class="ai-chat-messages"></div>
                            <form id="ai-chat-form" class="ai-chat-input">
                                <input id="ai-chat-input" type="text" placeholder="Ask about products, services, pricing..." autocomplete="off" />
                                <button type="submit"><i class="fas fa-paper-plane"></i></button>
                            </form>
                        </div>
                        <div id="ai-toast" class="ai-toast"></div>
                    </div>
                </div>
                <script>
                    function checkIframeLoad() {
                        setTimeout(() => {
                            try {
                                const frame = document.getElementById('siteFrame');
                                if (frame.contentWindow.location.href === 'about:blank' || 
                                    frame.contentWindow.location.href.includes('blocked') ||
                                    frame.contentDocument.body.innerHTML.length < 100) {
                                    showIframeFallback();
                                }
                            } catch (e) {
                                showIframeFallback();
                            }
                        }, 3000);
                    }
                    
                    function showIframeFallback() {
                        document.getElementById('iframeFallback').style.display = 'flex';
                    }
                    
                    function hideIframeFallback() {
                        document.getElementById('iframeFallback').style.display = 'none';
                    }
                </script>
            `;
        }

        // Initialize
        renderFeatures();
        checkForDemo();
    </script>
</body>
</html>
